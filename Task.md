# Тема: Стриминговый сервис музыки

Дедлайн: 10 сентября 2021

Доска Trello: https://trello.com/invite/b/XKEp5G2q/1a801f58e4d194056e0d89a65c76dd70/music-streaming


## Что должно быть готово к финалу проекта:

* В гите должен быть запушен весь код проекта;  
* По завершении курса, просьба проект скрыть из общего доступа, чтобы будущие студенты не копировали;
* Репозиторий должен содержать понятные инструкции по сборке и старту проекта;
* Проект должен собираться и запускаться;
* Репозиторий должен содержать тестовую базу с демо-данными;
* Помимо этого должна быть приготовлена презентация своего проекта, в которой объясняется о чем проект, что он умеет, как сделан и на чем. Презентация должна продавать проект условному заказчику;
* Должно быть подготовлено выступление на 5 минут, презентующее свой проект, иметь четкую структуру подачи;
* Нужно быть готовым отвечать 5 минут на сопутствующие вопросы и защищать свой проект оппонентам со стороны условного кастомера;


## Технический стек

Финальное приложение должно работать с наилучшей производительностью и проходить тестирование на следующей конфигурации виртуальной машины:

* OS: Ubuntu Server 20.04 LTS  
* VCPU: 4  
* RAM: 8GB  
* SSD: 40GB  


## Техническое задание

По техническому заданию нужно строго сделать проект со всем функционалом. Техническое задание содержит подсказки по структуре объектов и поведению методов. Отсутствующие элементы задания и определений поведения могут обсуждаться и делаются по своему усмотрению.



## Ключевые фичи:

* Поиск, просмотр и прослушивание песен, альбомов, артистов  
* Аккаунты пользователей и правообладателей (артистов)  
* Добавление песен в библиотеку и плейлисты  
* История прослушиваний, лайки и рекомендации на их основе  
* Админ-панель для управления музыкой артистом  
* Статистика прослушиваний и заработок артиста за период (день, неделю, месяц, год), с учетом разных региональных цен подписки 
* Синхронизация прослушивания между устройствами  


## Технические требования к реализации:

* Пользователи:
    * Регистрация новых пользователей, объект пользователя содержит:
        * ID пользователя (нельзя менять, присваивается автоматически)
        * Тип учетный записи (нельзя менять, возможные типы: «пользователь», «правообладатель», «администратор»)
        * Юзернейм
        * Пароль (скрытое поле)
        * Имя 
        * Фамилия
        * Регион (по своему выборы, можно код страны, можно связанную сущность)
        * Почтовый адрес email
        * Дата создания аккаунта (скрытое поле, нельзя менять, назначается автоматически один раз)
        * Дата последнего входа в аккаунт (скрытое поле, нельзя менять)
        * Привязанный ID исполнителя
    * Вход в профиль по юзернейму/почте/телефону и паролю (создание сессии, возвращает ID)
    * Выход из текущего профиля (удаление сессии)
    * Чтение профиля пользователя по ID (доступно только пользователю о самом себе или же администратору для всех)
    * Получение списка всех пользователей (доступно только администратору)
    * Изменение данных пользователя (кроме ID исполнителя)
    * Смена почты (для смены почты нужно передать в обязательном порядке текущий пароль и новую почту)
    * Смена пароля пользователя текущего пользователя (подтверждается двумя одинаковыми паролями)
    * Смена ID исполнителя (доступно только администратору)
    * Удаление пользователя по ID (доступ к этому методу имеет только администратор, при удалении должны быть стерты все плейлисты, прослушивания, отметки мне нравится, кэшированные рекомендации пользователя)
* Музыкальные жанры
    * Создание жанра (доступ имеет только администратор), объекты содержат следующее:
        * ID жанра
        * Наименование на английском
    * Редактирование жанра (доступ имеет только администратор)
    * Удаление жанра (доступ имеет только администратор, при удалении во всех песнях и альбомах с этим жанром выставляется null)
* Песни
    * Создание песни (доступно только правообладателю привязанного исполнителя и администратору), объект песни содержит:
        * ID песни (нельзя менять, присваивается автоматически)
        * ID пользователя-правообладателя (скрытое поле)
        * ID альбома, в который входит песня (обязательное поле)
        * ID главного исполнителя (обязательное поле)
        * ID всех причастных исполнителей (все кто feat. и прочие такие, может быть null)
        * ID музыкального жанра (может быть null)
        * Доступность песни к прослушиванию (булеан, по умолчанию false)
        * Длительность песни (в миллисекундах)
        * ID файла песни (может быть null)
        * Слова песни (размер поля имеет ограничение в 2000 символов, может быть пустым)
        * Автор песни/текста (может быть пустым)
        * Номер диска в альбоме (может быть пустым)
        * Дата выпуска песни (может быть пустым)
        * Дата создания песни (скрытое поле, нельзя менять, присваивается автоматически)
        * Дата изменения песни (скрытое поле, присваивается автоматически)
    * Чтение песни, помимо возврата объекта самой песни возвращается следующая информация:
        * Вместо ID альбома возвращается сам объект альбома
        * Вместо ID исполнителей возвращаются сами объекты исполнителей
        * Вместо ID жанра возвращается сам музыкальный жанр
        * Если ID файла песни null, то доступность песни к прослушиванию всегда возвращается как false
    * Чтение всех песен альбома (каждая песня возвращается как объект, возвращается список объектов)
    * Чтение всех песен исполнителя (каждая песня возвращается как объект, возвращается список объектов)
    * Редактирование песни (кроме ID файла песни, доступ к этому методу имеет только правообладатель этого объекта или администратор, менять ID пользователя-правообладателя и ID главного исполнителя нельзя; редактирование приводит к автоматическому обновлению даты изменения песни)
    * Смена пользователя-правообладателя и ID главного исполнителя (доступ есть только у администратора)
    * Удаление песни (доступ к этому методу имеет только правообладатель этого объекта или администратор, удаление должно стереть все foreign ключи из связанных таблиц: альбомы, исполнители, отметки мне нравится, прослушивание песни, кэш рекомендаций песен, песни, добавленные в плейлисты, текущие прослушиваемые, удаляется файл песни с диска)
    * Загрузка файла песни (доступ к методу только у правообладателя песни, файл песни сохраняется на сервер с рандомным именем UUID в виде ID, в базу записывается ID, возвращает ID; максимальный размер файла - 50мб, должна быть проверка)
    * Удаление файла песни (доступ есть только у правообладателя или администратора, ID выставляется в null, доступность песни к прослушиванию выставляется в false, файл стирается с сервера)
    * Неполный поиск песни по названию (возвращается список песен, попадающих под запрос)
* Альбомы 
    * Создание альбома (доступно только правообладателю привязанного исполнителя и администратору), объект альбома содержит:
        * ID альбома (нельзя менять, присваивается автоматически)
        * Дата выпуска альбома
        * Дата создания альбома (скрытое поле, нельзя менять, присваивается автоматически)
        * Дата изменения альбома (скрытое поле, присваивается автоматически)
        * ID жанра альбома
        * ID картинки-обложки альбома
        * Булеан отметка о single/ep-альбоме (по умолчанию false)
        * Количество дисков в альбоме (может быть null)
    * Дата создания альбома (скрытое поле, нельзя менять, присваивается автоматически)
    * Дата изменения альбома (скрытое поле, присваивается автоматически)
    * Чтение альбома
    * Получение списка всех альбомов исполнителя (список возвращает все альбомы как объекты)
    * Получение списка всех исполнителей в альбоме (включая вспомогательных, исполнители возвращаются списком как объекты)
    * Редактирование альбома (кроме ID картинки-обложки, доступ к этому методу имеет только правообладатель этого объекта или администратор; редактирование приводит к автоматическому обновлению даты изменения альбома)
    * Загрузка файла картинки-обложки (доступ к методу только у правообладателя песни, файл песни сохраняется на сервер с рандомным именем UUID в виде ID, в базу записывается ID, возвращает ID; максимальный размер файла - 5мб, должна быть проверка)
    * Удаление файла картинки-обложки (доступ есть только у правообладателя или администратора, ID выставляется в null)
    * Неполный поиск альбома по названию (возвращается список альбомов, попадающих под запрос)
* Исполнители
    * Создание исполнителя (доступно только администратору), объект исполнителя содержит следующие:
        * ID исполнителя (нельзя менять, присваивается автоматически)
        * Имя исполнителя
        * ID фотографии исполнителя
        * Дата создания исполнителя (скрытое поле, нельзя менять, присваивается автоматически)
        * Дата изменения исполнителя (скрытое поле, присваивается автоматически)
    * Редактирование исполнителя (кроме ID фотографии, доступно правообладателю и администратору; редактирование приводит к автоматическому обновлению даты изменения исполнителя)
    * Удаление исполнителя (доступно только администратору, удаление приводит к стиранию всех связанных альбомов, песен (только если исполнитель главный), удаление фотографии исполнителя, удаление песни из всех плейлистов, далее зависимые: истории прослушиваний, кэшей рекомендаций, отметок мне нравится песен)
    * Получение списка всех исполнителей (доступно только администратору)
    * Неполный поиск исполнителя по имени (возвращается список исполнителей, попадающих под запрос)
* Отметки «мне нравится» у песен:
    * Создание отметки, объект содержит:
        * ID отметки (нельзя менять, присваивается автоматически)
        * ID песни
        * ID аккаунта
        * Дата отметки (нельзя менять, присваивается автоматически)
    * Удаление отметки
* Прослушивание песни:
    * Создание прослушивания, объект имеет следующие поля:
        * ID прослушивания (нельзя менять, присваивается автоматически)
        * ID песни
        * ID пользователя
        * Дата прослушивания (нельзя менять, присваивается автоматически)
        * Процент прослушивания
    * Получение списка всех прослушиваний песни всех пользователей в период с/по (доступно только для правообладателя песни и администратору)
    * Получение списка прослушиваний всех песен определенного пользователя в период с/по (доступно только пользователю о самом себе, правообладателю песни и администратору)
    * Получение статистики прослушивания определенной песни за период (день, неделю, месяц, год), в ответе должны быть представлены следующие сведения (доступно только для правообладателя песни и администратору):
        * Количество прослушиваний
        * Количество пользователей, прослушавших песню
        * Среднее количество и 50-перцентиль прослушиваний на одного пользователя
        * Процентное распределение слушателей по регионам
        * Примерный заработок правообладателя (считается следующем образом: сумма всех прослушиваний регионов умноженных на их региональные ставки)
    * Получение статистики прослушивания всех композиций правообладателя за период, с аналогичными сведениями на выходе что и в предыдущем пункте (доступно только для правообладателя песни и администратору)
* Рекомендации песен:
    * Количество рекомендуемых песен: 30
    * Рекомендации должны генерироваться по запросу и кэшироваться в базе на 1 день. В ответе должен быть возвращен список объектов песен.
    * Генерация рекомендаций прослушиваний делаются по своему усмотрению, однако должны учитываться следующие параметры:
        * История прослушиваний пользователя за последний месяц (формально необходимо найти пользователей с общими прослушиваниями и вернуть их прослушивания, которые не пересекаются с текущим пользователем)
        * Лайки пользователя за последний год
        * Жанры, которые пользователь предпочитает на основе прослушиваний за последний год
    * Сброс кэша всех рекомендаций (доступно только администратору)
* Плейлисты:
    * Каждый аккаунт с типом пользователя автоматически свой имеет технический плейлист «main» - этот плейлист является основной библиотекой по умолчанию
    * Создание плейлиста, объект плейлиста содержит:
        * ID плейлиста (нельзя менять, присваивается автоматически)
        * ID пользователя-владельца (нельзя менять, присваивается автоматически)
        * Название плейлиста
        * Описание плейлиста
        * ID обложки плейлиста
    * Удаление плейлиста (право на удаление плейлиста имеет только его владелец или администратор, при удалении плейлиста стираются все связанные значения из таблицы песен, добавленных в плейлист, а также стирается файл изображения-обложки плейлиста)
    * Редактирование данных плейлиста (кроме ID обложки плейлиста, доступно только владельцу плейлиста и администратору)
    * Загрузка изображения обложки плейлиста (доступ к методу только у владельца плейлиста, файл фото сохраняется на сервер с рандомным именем UUID в виде ID, в базу записывается ID, возвращает ID; максимальный размер фотографии - 2мб, должна быть проверка)
    * Удаление изображения обложки плейлиста (доступ только у пользователя-владельца, ID выставляется в null, файл стирается с сервера)
* Песни, добавленные в плейлист
    * Добавление песни в аккаунт, объект добавленной песни содержит:
        * ID добавления (нельзя менять, присваивается автоматически)
        * ID песни
        * ID плейлиста
        * Дата добавления (нельзя менять, присваивается автоматически)
    * Получение списка всех песен аккаунта пользователя, в том числе начиная с определенного ID, а также как в порядке добавления, так и в перемешку (доступно только пользователю самого для себя)
    * Удаление песни из плейлиста 
* Текущая воспроизводимая песня
    * Изменение состояния текущего воспроизведения, объект состояния должен содержать данные:
        * ID пользователя (скрытое, нельзя менять)
        * ID песни, которая воспроизводится
        * Количество секунд прошедших с момента начала воспроизведения
        * Наличие паузы (булеан)
        * Время обновления состояния
    * Получение текущего состояния воспроизведения (доступно состояние пользователя самому себе)
    * Должна быть процедура очистки состояний из базы, если их время обновления старше 7 дней
    * Сброс всех состояний (доступен только администратору)
* Магический поиск (бонусная задача)
    * Поиск сразу по нескольким названиям связанных и несвязанных сущностей, например, когда пользователь указал первую часть имени исполнителя и первую часть названия его песни
    * Поиск с ошибками в написании


Помимо предустановленных статических тестовых данных должны быть автоматически генерированы тестовые данные пользователей и их прослушиваний со следующими параметрами:

* Количество тестовых пользователей в базе: 100,000
* Количество прослушиваний на каждого пользователя должно быть случайным и распределенным на год, среднее количество прослушиваний должно быть около 200 прослушиваний в месяц на каждого слушателя
* Количество лайков на каждого пользователя должно быть случайным и составлять 1/20 от всех прослушиваний


## Региональные ставки на одно прослушивание:

* Северная америка - 0.015$
* Южная америка - 0.011$
* Австралия и Океания - 0.009$
* Китай - 0.02$
* Индия - 0.005$
* Россия - 0.007$
* Великобритания - 0.012$
* Азиатский регион - 0.013$
* Африканский регион - 0.006$
* Европейский регион - 0.01$
* Остальные регионы - 0.008$


## Технические требования:

* В качестве сервера нужно использовать Apache Tomcat
* В качестве базы данных нужно использовать Postgres или Oracle Database
* Версия Java не принципальна, выбирается по своему усмотрению начиная с Java 8
* Должна быть инструкция, описывающая пререквизиты к серверу, а также объясняющая как запустить сервер и базу данных с нуля, при этом нужно иметь скрипт, заполняющий базу приложения демо-данными.  
* Проект должен использовать подход коммуникации через публичный API:  
  * Вся коммуникация клиента с сервером должна протекать только через публичные API методы. Методы должны иметь вид /api/1.0/foo/bar, запросы должны быть логически разделены на GET/POST/PUT/DELETE методы. Для тестирования методов я порекомендую использовать приложение Postman.
  * Каждый метод обязан возвращать корректные коды ошибок (https://en.wikipedia.org/wiki/List_of_HTTP_status_codes), ответы должны быть в формате JSON, содержать данные ответа, а также содержать описание ошибки, если есть.
  * Все API должно быть детально описано в документации (хранить в папке docs/). На каждый метод должно быть описание что делает, описание каждого параметра, а также примеры использования. Если метод возвращает ошибки, нужно описать в каких ситуациях, почему и как их определять. Для примера порекомендую изучить как это сделано у других:
    * https://vk.com/dev/methods
    * https://api.cloudflare.com/#getting-started-requests
    * https://developer.twitter.com/en/docs/twitter-api/v1/accounts-and-users/follow-search-get-users/api-reference/get-users-lookup
* Проект должен иметь юнит-тесты, coverage должен составлять не менее 80%
* Необходимо использовать Spring/Spring Boot/Maven:
    * Проект и зависимости должны собираться только через Maven
    * Бинды API урлов сервера должны реализовываться средствами Spring
    * Авторизация и сессия должны реализовываться средствами Spring (Authentication module)
    * Юнит тесты должны быть реализованы через Spring и запускаться при вызове maven install процедуры
* Все методы, возвращающие списки, должны поддерживать «паджинацию» - возврат определенной страницы результата ответа с определенным количеством элементов. Клиент может манипулировать этими переменными в рамках своего запроса.
* Обязательно использовать следующие паттерны:
    * Фабрика и/или Абстрактная фабрика
    * Строитель
    * Мост
    * Фасад
    * Состояние
* Все важные переменные (порт сервера, креденшелы к базам данных или другие магические константы) должны быть вынесены в application.properties через Spring Boot
* Все пароли пользователей в базе хранятся исключительно в SHA256
* В коде каждый класс/метод должен иметь свой docstring с понятным описанием
* Приложение должно поддерживать запись логов на 4 уровнях: ошибка, предупреждение, информационное сообщение и дебаг-сообщение. Для этого нужно настроить и использовать log4j, причем для финальной версии должен быть установлен INFO-уровень логирования. Соответственно, весь код должен быть наполнен логирующими методами, там где это нужно.
* Код клиента должен быть оформлен в виде связки HTML/CSS/JS. Желательно сделать все красиво и использовать весь стек, но это уже по имеющимся возможностям/силам/желанию. Однако клиент обязан ходить на сервер через API, а значит нужно использовать Ajax и XHR. Помимо этого можно использовать шаблонизатор Thymeleaf для получения страниц сразу с готовой версткой.
* Все длинные списки элементов обязаны быть lazy - то есть подгружаться по мере просмотра, а не сразу вся тысяча элементов.

## Бонусные фичи (если останется время и будет желание):

* Кэширование основных объектов в памяти (Spring Caching)
* Оформление приложения в виде docker-контейнера, управление всей связкой бэкенда через docker-compose
* CI автосборка и автотесты на каждый коммит, PR
* На сервере должен быть настроен gzip и cache-control
* Сессия пользователей должна длиться не более 1 часа, при этом любое обращения к любому методу должно продлять сессию на час вперед
